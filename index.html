<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tone</title>
    <style>
        :root {
            --halfNote: rgb(17, 200, 17);
            --doubleNote: skyblue;
            --singleNote: #B96AD2;
        }

        html {
            font-family: sans-serif;
            background: #e6e7e8;
        }

        body {
            margin: 0 auto;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            align-content: center;
            justify-content: center;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: 5px 5px 5px lightgrey;
            position: relative;
            border-radius: 0.4em;
        }

        .card_hidden {
            height: 5px !important;
            overflow-y: hidden;
        }

        .card_hide_toggle {
            position: absolute;
            top: 0;
            right: 0;
            width: 1em;
            height: 1em;
            margin: 3px;
            background: lightgray;
            border-radius: 25% 25% 25% 100%;
            line-height: 1em;
        }

        .card_hidden>div {
            filter: opacity(0.1);
        }

        .card_hidden>.card_hide_toggle {
            background: grey;
        }

        #theGrid {
            background: #e6e7e8;
            color: white;
            text-align: center;
            user-select: none;
            table-layout: fixed;
            /*             contain: strict; */
        }

        #theGrid td:first-of-type {
            background: #5986D9;
            color: white;
            font-weight: bold;
            padding-left: 3px;
            padding-right: 3px;
            cursor: default;
            border-radius: unset;
        }

        #theGrid td:first-of-type:hover {
            box-shadow: unset;
            background: #5986D9;
        }

        #theGrid td:hover {
            box-shadow: 0px 0px 3px black;
            background: rgba(255, 255, 255, 0.418);
        }

        #theGrid,
        #theGrid td,
        #theGrid tr,
        #theGrid th {
            border: 1px solid #cfcfcf;
            border-collapse: collapse;
            font-family: monospace;
        }

        #theGrid td {
            height: 25px;
            width: 25px;
            cursor: pointer;
            border-radius: 3px;
        }

        #theGrid th {
            height: 15px;
            width: 25px;
            background: lightgray;
            color: lightgray;
            cursor: pointer;
        }

        #theGrid th:hover {
            color: black;
            background: grey;
        }

        #theGrid tr:hover {
            background: rgb(181, 181, 181);
        }

        #theGrid tr:nth-child(12n) td {
            border-bottom: 1px solid #425d90 !important;
        }

        #theGrid tr:last-child td {
            border-bottom: unset !important;
        }

        #controls,
        #gridContainer {
            display: flex;
            justify-content: center;
            flex-direction: column;
            align-items: center;
            min-width: 450px;
        }

        #gridContainer {
            overflow-x: scroll;
            align-items: stretch;
        }

        button {
            margin: 3px;
        }

        select,
        input {
            background: white;
            color: black;
            box-shadow: 2px 2px 4px #80808080, -2px -2px 4px #ffffff6b;
            border-radius: 0.4em;
            border: 1px solid rgb(237, 237, 237);
            transition: border 0.5s;
            cursor: pointer;
            user-select: none;
            padding: 7px;
            margin: 3px;
        }

        .currentStep {
            background: #b9b9b9;
        }

        #theGrid td.activeCell {
            background: var(--singleNote);
        }

        #theGrid td.activeCellHalf01 {
            background: linear-gradient(-90deg, var(--halfNote) 0%, var(--halfNote) 50%, rgba(255, 255, 255, 0) 50%, rgba(255, 255, 255, 0) 100%);
        }

        #theGrid td.activeCellHalf10 {
            background: linear-gradient(90deg, var(--halfNote) 0%, var(--halfNote) 50%, rgba(255, 255, 255, 0) 50%, rgba(255, 255, 255, 0) 100%);
        }

        #theGrid td.activeCellHalf11 {
            background: linear-gradient(90deg, var(--halfNote) 0%, var(--halfNote) 49%, black 49%, black 51%, var(--halfNote) 51%, var(--halfNote) 100%);
        }

        #theGrid td.activeCellDouble {
            background: var(--doubleNote);
        }

        .skeuButton {
            background: white;
            color: black;
            box-shadow: 2px 2px 4px #80808080, -2px -2px 4px #ffffff6b;
            border-radius: 0.4em;
            border: 1px solid rgb(237, 237, 237);
            /* transition: border 0.5s; */
            cursor: pointer;
            user-select: none;
            padding: 7px;
        }

        .skeuButton:active {
            color: darkblue;
            box-shadow: inset 2px 2px 4px #80808080, inset -2px -2px 4px #ffffff6b;
        }

        .skeuButton:disabled {
            color: lightgray;
        }

        .skeuButton:hover {
            border: 1px solid rgb(217, 217, 217);
        }

        #exportDiv textarea {
            height: 100px;
            margin: 5px;
            width: 100%;
            width: -moz-available;
            width: -webkit-fill-available;
            width: fill-available;
            border-radius: 0.4em;
        }

        #exportDiv {
            display: flex;
            flex-direction: column;
        }

        #loadExportButtonsDiv {
            display: flex;
            flex-direction: row;
            align-items: stretch;
            justify-content: space-between;
        }

        #noteDurationSwitcher {
            position: fixed;
            right: 10px;
            bottom: 10px;
            width: 30px;
            height: 30px;
            background: white;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.411);
            border-radius: 10px;
            border: 7px solid white;
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            color: rgba(255, 255, 255, 0);
            transition: box-shadow 0.3s, color 0.2s;
            cursor: pointer;
            z-index: 1000;
        }

        #noteDurationSwitcher:hover {
            box-shadow: 0px 0px 15px rgba(0, 0, 0, 0.689);
            color: white;
        }

        #noteDurationSwitcher.double {
            background: var(--doubleNote);
        }

        #noteDurationSwitcher.double::after {
            content: "2x";
        }

        #noteDurationSwitcher.single {
            background: var(--singleNote);
        }

        #noteDurationSwitcher.single::after {
            content: "1x";
        }

        #noteDurationSwitcher.half {
            background: var(--halfNote);
        }

        #noteDurationSwitcher.half::after {
            content: "½x";
        }
    </style>
    <script src="res/tracks.js"></script>
</head>

<body>

    <div id="controls" class="card">
        <table>
            <tr>
                <td>Steps</td>
                <td><input id="stepSpinner" type="number" onchange="stepChange(parseInt(this.value))" min="1" /></td>
            </tr>
            <tr>
                <td>Step duration</td>
                <td><input id="stepDurationSpinner" type="number" value="0.5" step="0.01" min="0.01" onchange="stepDurationChange(parseFloat(this.value))" /></td>
            </tr>
        </table>

        <div>
            <div>
                <button class="skeuButton" onclick="initAudioContext(); startAutoplay()">Start</button>
                <button class="skeuButton" onclick="stopAutoplay()">Stop</button>
                <button class="skeuButton" onclick="initAudioContext(); advanceStep()">Step</button>
                <button class="skeuButton" onclick="highlightStep(-1)">&lt;&lt;</button>
                <select id="waveformSelection" onchange="changeWaveform(this.value)">
                    <option disabled="" selected="">Waveform</option>
                    <option value="sine">Sine</option>
                    <option value="square">Square</option>
                    <option value="sawtooth">Sawtooth</option>
                    <option value="triangle">Triangle</option>
                </select>
            </div>
            <div>
                <!-- <button class="skeuButton" onclick="loadTrack(tracks.stillAlive)">Load</button> -->
                <button class="skeuButton" onclick="clearNotes()">Clear</button>
                <div id="trackSelection" style="display: inline-block"></div>
                <button class="skeuButton" onclick="doLoad()">Load</button>
                <button class="skeuButton" onclick="doExport()">Export</button>
            </div>
            <div>
                <button class="skeuButton" onclick="insertColAtCurrentPos()">Insert column</button>
                <button class="skeuButton" onclick="deleteColAtCurrentPos()">Delete column</button>
                <button class="skeuButton" onclick="wideMode()">Wide mode</button>
            </div>
        </div>

        <div id="noteDurationSwitcher" class="single" onclick="cycleNoteDuration()"></div>
    </div>

    <div id="gridContainer" class="card">
        <table id="theGrid"></table>
    </div>

    <div id="postscript" class="card card_hidden">
        <span class='card_hide_toggle' onclick='hideCard(this)'></span>
        <p>This bit is experimental and likely to break everything</p>
        <table>
            <tr>
                <td>Number of octaves</td>
                <td><input id="octaveSpinner" type="number" value="2" step="1" min="2" onchange="octaveChange(parseFloat(this.value))" /></td>
            </tr>
            <tr>
                <td>Start octave</td>
                <td><input id="startOctaveSpinner" type="number" value="3" step="1" min="1" onchange="startOctaveChange(parseFloat(this.value))" /></td>
            </tr>
            <tr>
                <td>Bar length</td>
                <td><input id="barLengthSpinner" type="number" value="8" step="1" min="2" onchange="doBarShading(parseInt(this.value))"></input></td>
            </tr>
            <tr>
                <td>Game of Life</td>
                <td><button class="skeuButton" onclick="toggleConway(this)">Start</button></td>
            </tr>
            <tr>
                <td>Game of Life interval (ms)</td>
                <td><input type="number" value="500" step="1" min="1" onchange="conwayInterval = parseInt(this.value); restartConway()" /></td>
            </tr>
            <tr>
                <td>Multiply all steps by 2</td>
                <td>
                    <button class="skeuButton" onclick="doubleSpace()">Insert spaces</button>
                    <button class="skeuButton" onclick="doubleSpace(true)">Double notes</button>
                </td>
            </tr>
            <!-- <tr>
                <td>Note duration</td>
                <td>
                    <button class="skeuButton" onclick="removeAllNoteOnclickEvents(); addOnclickToGridCells(); notePickerDuration = 'single'">Whole</button>
                    <button class="skeuButton" onclick="removeAllNoteOnclickEvents(); addHalfNoteOnclickToGridCells(); notePickerDuration = 'half'">Half</button>
                    <button class="skeuButton" onclick="removeAllNoteOnclickEvents(); addDoubleNoteOnclickToGridCells(); notePickerDuration = 'double'">Double</button>
                </td>
            </tr> -->
            <tr>
                <td>Attack</td>
                <td><input type="number" value="1" step="0.01" min="0" max="1" onchange="setAttack(parseFloat(this.value))" /></td>
            </tr>
            <tr>
                <td>Release</td>
                <td><input type="number" value="0" step="0.01" min="0" max="1" onchange="setRelease(parseFloat(this.value))" /></td>
            </tr>
        </table>
    </div>

</body>
<script>
    'use strict'

    function stepChange(steps, noReload) {
        // var theGrid = document.getElementById("theGrid")
        var stepSpinner = document.getElementById("stepSpinner")
        var currentTrack = getTheScore()
        var newGridHTML = []

        stepCount = steps
        currentTrack["steps"] = steps

        newGridHTML.push("<table><thead>")
        newGridHTML.push("<th>&#9660;</th>".repeat(steps + 1))
        newGridHTML.push("</thead><tbody>")
        for (var i = 0; i < numberOfOctaves * 12; i++) {
            var rowHTML = []
            rowHTML.push("<tr>")
            for (var j = 0; j < (steps + 1); j++) {
                var cellHTML = ""
                if (!j) {
                    var note = chromaticScale[12 - ((i % 12) + 1)]
                    var octave = startOctave + numberOfOctaves - (1 + Math.floor(i / 12))
                    cellHTML = `<td class='step_${j - 1}' data-note="${note}${octave}">${note}${octave}</td>`
                }
                else {
                    cellHTML = `<td class='step_${j - 1}'></td>`
                }
                rowHTML.push(cellHTML)
            }
            rowHTML.push("</tr>")
            newGridHTML.push(rowHTML.join("\n"))
        }
        newGridHTML.push("</tbody></table>")
        theGrid.innerHTML = newGridHTML.join("\n")
        stepSpinner.value = steps

        cycleNoteDuration(true)

        if (!noReload) {
            loadTrack(currentTrack, true)
        }
    }

    function stepDurationChange(duration) {
        stepDuration = duration
        if (autoStepIntervalIdArray.length) {
            startAutoplay()
        }
    }

    function highlightStep(step) {
        currentStep = step
        document.title = `Step ${step + 1}/${theGrid.rows[0].cells.length - 1}`

        // unhighlight all steps
        // var colClass = document.querySelectorAll(".currentStep")
        var colClass = [...theGrid.getElementsByClassName("currentStep")]
        colClass.forEach(element => {
            element.classList.remove("currentStep")
        });

        // highlight step
        // var colClass = document.querySelectorAll(`.step_${step}`)
        var colClass = [...theGrid.getElementsByClassName(`step_${step}`)]
        colClass.forEach(element => {
            element.classList.add("currentStep")
        });
    }

    function advanceStep() {
        currentStep = (currentStep + 1) % stepCount
        highlightStep(currentStep)
        var notes = getCurrentStepActiveCellNoteArray()
        var halfNotes = getCurrentStepActiveCellHalfNoteArray()
        var doubleNotes = getCurrentStepActiveCellDoubleNoteArray()
        playChordArray(notes)
        playHalfChordArray(halfNotes)
        playDoubleChordArray(doubleNotes)

    }

    function addOnclickToGridCells() {
        // var theGrid = document.getElementById("theGrid")
        for (var row = 1; row < theGrid.rows.length; row++) {
            for (var col = 1; col < theGrid.rows[row].cells.length; col++) {
                var cell = theGrid.rows[row].cells[col]
                cell.onclick = function () {
                    if (this.classList.contains("activeCellHalf")) {
                        this.classList.remove(
                            "activeCellHalf",
                            "activeCellHalf01",
                            "activeCellHalf10",
                            "activeCellHalf11"
                        )
                    }
                    else if (this.classList.contains("activeCellDouble")) {
                        this.classList.remove("activeCellDouble")
                    }
                    else {
                        this.classList.toggle("activeCell")
                        if (this.classList.contains("activeCell")) {
                            initAudioContext();
                            playNoteByName(this.parentElement.cells[0].innerText)
                        }
                    }
                }
            }
        }
        // add event to headers
        for (var col = 0; col < theGrid.rows[0].cells.length; col++) {
            var cell = theGrid.rows[0].cells[col]
            cell.onclick = function () {
                highlightStep(Array.from(this.parentNode.children).indexOf(this) - 1)
            }
        }
    }

    function addDoubleNoteOnclickToGridCells() {
        for (var row = 1; row < theGrid.rows.length; row++) {
            for (var col = 1; col < theGrid.rows[row].cells.length; col++) {
                var cell = theGrid.rows[row].cells[col]
                cell.onclick = function () {
                    if (this.classList.contains("activeCellHalf")) {
                        this.classList.remove(
                            "activeCellHalf",
                            "activeCellHalf01",
                            "activeCellHalf10",
                            "activeCellHalf11"
                        )
                    }
                    else if (this.classList.contains("activeCell")) {
                        this.classList.remove("activeCell")
                    }
                    else if (this.classList.contains("activeCellDouble")) {
                        this.classList.remove("activeCellDouble")
                    }
                    else {
                        this.classList.add("activeCellDouble")
                        initAudioContext();
                        playDoubleNoteByName(this.parentElement.cells[0].innerText)
                    }
                }
            }
        }
        // add event to headers
        for (var col = 0; col < theGrid.rows[0].cells.length; col++) {
            var cell = theGrid.rows[0].cells[col]
            cell.onclick = function () {
                highlightStep(Array.from(this.parentNode.children).indexOf(this) - 1)
            }
        }
    }

    function addHalfNoteOnclickToGridCells() {
        for (var row = 1; row < theGrid.rows.length; row++) {
            for (var col = 1; col < theGrid.rows[row].cells.length; col++) {
                var cell = theGrid.rows[row].cells[col]
                cell.onclick = function () {
                    if (this.classList.contains("activeCell")) {
                        this.classList.remove("activeCell")
                    }
                    else if (this.classList.contains("activeCellDouble")) {
                        this.classList.remove("activeCellDouble")
                    }
                    else if (this.classList.contains("activeCellHalf10")) {
                        this.classList.remove("activeCellHalf10")
                        this.classList.add("activeCellHalf01")
                        initAudioContext();
                        playHalfNoteByName(this.parentElement.cells[0].innerText, "10")
                    }
                    else if (this.classList.contains("activeCellHalf01")) {
                        this.classList.remove("activeCellHalf01")
                        this.classList.add("activeCellHalf11")
                        initAudioContext();
                        playHalfNoteByName(this.parentElement.cells[0].innerText, "11")
                    }
                    else if (this.classList.contains("activeCellHalf11")) {
                        this.classList.remove("activeCellHalf11", "activeCellHalf")
                        initAudioContext();
                    }
                    else {
                        this.classList.add("activeCellHalf10", "activeCellHalf")
                        initAudioContext();
                        playHalfNoteByName(this.parentElement.cells[0].innerText, "01")
                    }
                }
            }
        }
        // add event to headers
        for (var col = 0; col < theGrid.rows[0].cells.length; col++) {
            var cell = theGrid.rows[0].cells[col]
            cell.onclick = function () {
                highlightStep(Array.from(this.parentNode.children).indexOf(this) - 1)
            }
        }
    }

    function removeAllNoteOnclickEvents() {
        for (var row = 1; row < theGrid.rows.length; row++) {
            for (var col = 1; col < theGrid.rows[row].cells.length; col++) {
                var cell = theGrid.rows[row].cells[col]
                cell.onclick = ""
            }
        }
        // add event to headers
        for (var col = 0; col < theGrid.rows[0].cells.length; col++) {
            var cell = theGrid.rows[0].cells[col]
            cell.onclick = ""
        }
    }

    function getCurrentStepActiveCellNoteArray() {
        // var noteElements = document.querySelectorAll(".activeCell.currentStep")
        var noteElements = [...theGrid.getElementsByClassName("currentStep")].filter(x => x.classList.contains("activeCell"))
        var noteArray = [...noteElements].map(x =>
            // x.parentElement.firstElementChild.innerText
            x.parentElement.firstElementChild.innerHTML //  innerText is slower, apparently
        )
        return noteArray ? noteArray : []
    }

    function getCurrentStepActiveCellDoubleNoteArray() {
        var noteElements = [...theGrid.getElementsByClassName("currentStep")].filter(x => x.classList.contains("activeCellDouble"))
        var noteArray = [...noteElements].map(x =>
            x.parentElement.firstElementChild.innerHTML
        )
        return noteArray ? noteArray : []
    }

    function getCurrentStepActiveCellHalfNoteArray() {
        var noteElements = [...theGrid.getElementsByClassName("currentStep")].filter(x => x.classList.contains("activeCellHalf"))
        var noteArray = [...noteElements].map(x =>
            [
                x.parentElement.firstElementChild.innerHTML,
                x.classList.contains("activeCellHalf01")
                    ? "01"
                    : x.classList.contains("activeCellHalf10")
                        ? "10"
                        : x.classList.contains("activeCellHalf11")
                            ? "11"
                            : undefined
            ]
        )
        return noteArray ? noteArray : []
    }

    function playNoteByName(noteName) {
        `
        Plays a note given a name, e.g. A4 or C♯3
        Will let you get away with using # instead of ♯
        Assumes you have an audio context called audioCtx
        `
        var noteFrequency = getFrequencyFromNoteName(noteName)

        // for reference
        // you can make a kickdrum with
        // oscillator.frequency.exponentialRampToValueAtTime(0.001, audioCtx.currentTime+0.5)

        var oscillator = audioCtx.createOscillator();
        oscillator.type = waveform ? waveform : "sine";
        oscillator.frequency.setValueAtTime(noteFrequency, audioCtx.currentTime); // value in hertz

        if (attackTime) {
            mainGainNode.gain.setValueAtTime(0, audioCtx.currentTime);
            mainGainNode.gain.linearRampToValueAtTime(1, attackTime)
        }

        if (releaseTime) {
            mainGainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + (stepDuration - releaseTime))
        }

        oscillator.connect(mainGainNode);
        oscillator.start();
        oscillator.stop(audioCtx.currentTime + stepDuration);
    }

    function playDoubleNoteByName(noteName) {
        `
        Plays a note given a name, e.g. A4 or C♯3
        Will let you get away with using # instead of ♯
        Assumes you have an audio context called audioCtx
        `
        var noteFrequency = getFrequencyFromNoteName(noteName)
        var oscillator = audioCtx.createOscillator();

        oscillator.type = waveform ? waveform : "sine";
        oscillator.frequency.setValueAtTime(noteFrequency, audioCtx.currentTime); // value in hertz
        oscillator.connect(mainGainNode);
        oscillator.start();
        oscillator.stop(audioCtx.currentTime + (stepDuration * 2));
    }

    function playHalfNoteByName(noteName, pattern) {
        `
        Plays a note given a name, e.g. A4 or C♯3
        Will let you get away with using # instead of ♯
        Assumes you have an audio context called audioCtx
        `
        var noteFrequency = getFrequencyFromNoteName(noteName)

        var oscillator = audioCtx.createOscillator();
        oscillator.type = waveform ? waveform : "sine";
        oscillator.frequency.setValueAtTime(noteFrequency, audioCtx.currentTime); // value in hertz
        oscillator.connect(mainGainNode);

        var oscillator2 = audioCtx.createOscillator();
        oscillator2.type = waveform ? waveform : "sine";
        oscillator2.frequency.setValueAtTime(noteFrequency, audioCtx.currentTime); // value in hertz
        oscillator2.connect(mainGainNode);

        if (pattern == "01") {
            oscillator.start(audioCtx.currentTime + (stepDuration / 2));
            oscillator.stop(audioCtx.currentTime + stepDuration);
        }
        else if (pattern == "10") {
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + (stepDuration / 2));
        }
        else if (pattern == "11") {
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + (stepDuration / 2));
            oscillator2.start(audioCtx.currentTime + (stepDuration / 2));
            oscillator2.stop(audioCtx.currentTime + stepDuration);
        }
        else {
            console.error("Invalid pattern provided to playHalfNoteByName()")
        }
    }

    function getFrequencyFromNoteName(noteName) {
        `
        Gets frequency in Hz for a note given a name, e.g. A4 or C♯3
        Will let you get away with using # instead of ♯
        Breaks above G#9 because of the assumption that the octave is always a single digit
        `
        var note = noteName.slice(0, noteName.length - 1).replace("#", "♯")
        var octave = parseInt(noteName.slice(noteName.length - 1))
        var noteIdx = chromaticScale.indexOf(note)

        var noteValueRelativeToA4 = noteIdx + (12 * (octave - 4))
        var noteFrequency = (2 ** (noteValueRelativeToA4 / 12)) * 440

        return noteFrequency
    }

    function playChordArray(chordArray) {
        if (!chordArray.length) {
            return
        }
        // chordArray.map(x => setTimeout(playNoteByName, 0, x))
        chordArray.map(x => playNoteByName(x))
    }

    function playHalfChordArray(chordArray) {
        if (!chordArray.length) {
            return
        }
        // chordArray.map(x => setTimeout(playHalfNoteByName, 0, x[0], x[1]))
        chordArray.map(x => playHalfNoteByName(x[0], x[1]))
    }

    function playDoubleChordArray(chordArray) {
        if (!chordArray.length) {
            return
        }
        // chordArray.map(x => setTimeout(playDoubleNoteByName, 0, x))
        chordArray.map(x => playDoubleNoteByName(x))
    }

    function getTheScore(asString) {
        var theScore = {}

        theScore["notes"] = [...theGrid.getElementsByClassName("activeCell")].map(x =>
            [
                x.parentElement.cells[0].innerText,
                Array.from(x.parentNode.children).indexOf(x) - 1
            ]
        )

        theScore["doublenotes"] = [...theGrid.getElementsByClassName("activeCellDouble")].map(x =>
            [
                x.parentElement.cells[0].innerText,
                Array.from(x.parentNode.children).indexOf(x) - 1
            ]
        )

        theScore["halfnotes"] = [...theGrid.getElementsByClassName("activeCellHalf")].map(x =>
            [
                x.parentElement.cells[0].innerText,
                Array.from(x.parentNode.children).indexOf(x) - 1,
                x.classList.contains("activeCellHalf01")
                    ? "01"
                    : x.classList.contains("activeCellHalf10")
                        ? "10"
                        : x.classList.contains("activeCellHalf11")
                            ? "11"
                            : undefined
            ]
        )

        theScore["steps"] = stepCount
        theScore["duration"] = stepDuration
        theScore["waveform"] = waveform
        theScore["octaves"] = numberOfOctaves
        theScore["startOctave"] = startOctave

        if (asString) {
            return JSON.stringify(theScore)
        }
        else {
            return theScore
        }
    }

    function loadTrack(trackData, noStepChange) {
        clearNotes()

        // load the data
        var notesArray = trackData["notes"]
        var doubleNotesArray = trackData["doublenotes"] ? trackData["doublenotes"] : []
        var halfNotesArray = trackData["halfnotes"] ? trackData["halfnotes"] : []
        var steps = trackData["steps"]
        var duration = trackData["duration"]
        var waveform = trackData["waveform"]
        var octaves = Object.keys(trackData).includes("octaves") ? trackData["octaves"] : 2
        var octaveStart = Object.keys(trackData).includes("startOctave") ? trackData["startOctave"] : 3

        if (!notesArray) {
            console.warn("No notes in trackData")
            return
        }

        // octaves
        document.getElementById("octaveSpinner").value = octaves
        document.getElementById("startOctaveSpinner").value = octaveStart
        numberOfOctaves = octaves
        startOctave = octaveStart

        // steps
        document.getElementById("stepSpinner").value = steps
        stepCount = steps
        stepChange(steps, true)

        // notes
        for (var i = 0; i < notesArray.length; i++) {
            var note = notesArray[i][0]
            var step = notesArray[i][1]
            var rowElement = document.querySelector(`[data-note=${note}]`).parentElement
            try {
                var cell = rowElement.cells[step + 1]
                cell.classList.add("activeCell")
            }
            catch {
                console.warn(`Cannot place ${note} at step ${step}, truncating score`)
            }
        }

        // double notes
        for (var i = 0; i < doubleNotesArray.length; i++) {
            var note = doubleNotesArray[i][0]
            var step = doubleNotesArray[i][1]
            var rowElement = document.querySelector(`[data-note=${note}]`).parentElement
            try {
                var cell = rowElement.cells[step + 1]
                cell.classList.add("activeCellDouble")
            }
            catch {
                console.warn(`Cannot place doublenote ${note} at step ${step}, truncating score`)
            }
        }

        // half notes
        for (var i = 0; i < halfNotesArray.length; i++) {
            var note = halfNotesArray[i][0]
            var step = halfNotesArray[i][1]
            var halfNoteType = halfNotesArray[i][2]
            var rowElement = document.querySelector(`[data-note=${note}]`).parentElement
            try {
                var cell = rowElement.cells[step + 1]
                cell.classList.add("activeCellHalf", `activeCellHalf${halfNoteType}`)
            }
            catch {
                console.warn(`Cannot place halfnote ${note} at step ${step}, truncating score`)
            }
        }

        // step duration
        document.getElementById("stepDurationSpinner").value = duration
        stepDurationChange(duration)

        // waveform
        document.getElementById("waveformSelection").value = waveform
        changeWaveform(waveform)
    }

    function initAudioContext() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            mainGainNode = audioCtx.createGain();
            mainGainNode.connect(audioCtx.destination);
            mainGainNode.gain.value = volume;
        }
    }

    function clearNotes() {
        const classesToRemove = [
            "activeCell",
            "activeCellDouble",
            "activeCellHalf",
            "activeCellHalf01",
            "activeCellHalf10",
            "activeCellHalf11"
        ]
        for (var i = 0; i < classesToRemove.length; i++) {
            var tempClass = classesToRemove[i]
            document.querySelectorAll(`.${tempClass}`).forEach(element => {
                element.classList.remove(tempClass)
            });
        }
    }

    function startAutoplay() {
        stopAutoplay()
        autoStepIntervalIdArray.push(setInterval(advanceStep, stepDuration * 1000))
    }

    function stopAutoplay() {
        while (autoStepIntervalIdArray.length) {
            clearInterval(autoStepIntervalIdArray.pop())
        }
    }

    function trackSelectorGenerator() {
        var outhtml = "<select onchange='loadTrack(tracks[this.value])' id='trackSelection'><option disabled selected>Select a track</option>"
        var caArray = Object.keys(tracks).sort()

        for (var ca_idx in caArray) {
            outhtml += `<option value='${caArray[ca_idx]}'>${caArray[ca_idx]}</option>`
        }
        outhtml += "</select>"
        document.getElementById("trackSelection").innerHTML = outhtml
    }

    function doExport() {
        if (document.getElementById("exportDiv")) {
            document.getElementById("exportText").value = getTheScore(1)
        }
        else {
            createLoadExportCard()
            doExport()
        }
    }

    function download(filename, text) {
        var element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        element.setAttribute('download', filename);

        element.style.display = 'none';
        document.body.appendChild(element);

        element.click();

        document.body.removeChild(element);
    }

    function doLoad() {
        if (document.getElementById("exportDiv")) {
            loadTrack(JSON.parse(document.getElementById("exportText").value))
        }
        else {
            createLoadExportCard()
        }
    }

    function createLoadExportCard() {
        var node = document.createElement("div")
        node.id = "exportDiv"
        node.classList.add("card")
        var textareaNode = document.createElement("textarea")
        textareaNode.id = "exportText"
        textareaNode.placeholder = "Paste track data in here (or choose file) then click load again"
        node.appendChild(textareaNode)
        document.getElementById("controls").after(node)

        var loadExportButtonsDiv = document.createElement("div")
        loadExportButtonsDiv.id = "loadExportButtonsDiv"
        node.appendChild(loadExportButtonsDiv)

        var uploadButton = document.createElement("input")
        uploadButton.setAttribute("type", "file")
        uploadButton.id = "file"
        uploadButton.oninput = loadTrackFromJsonFile
        uploadButton.classList.add("skeuButton")
        uploadButton.textContent = "Open file"
        loadExportButtonsDiv.appendChild(uploadButton)

        var button = document.createElement("button")
        button.onclick = function () {
            download("track.json", textareaNode.value)
        }
        button.classList.add("skeuButton")
        button.textContent = "Download"
        loadExportButtonsDiv.appendChild(button)
    }

    function changeWaveform(waveformSetting) {
        waveform = waveformSetting
    }

    function reloadTrack() {
        loadTrack(getTheScore())
    }

    function octaveChange(octave) {
        numberOfOctaves = octave
        reloadTrack()
    }

    function startOctaveChange(octave) {
        startOctave = octave
        reloadTrack()
    }

    function hideCard(card) {
        card.parentElement.classList.toggle("card_hidden")
    }

    function insertColAtCurrentPos() {
        var currentScore = getTheScore()
        var newScore = currentScore
        var currentScoreNotesArray = currentScore["notes"]
        var currentScoreHalfNotesArray = currentScore["halfnotes"]
        var currentScoreDoubleNotesArray = currentScore["doublenotes"]
        var newScoreNotesArray = []
        var newScoreHalfNotesArray = []
        var newScoreDoubleNotesArray = []

        for (var i = 0; i < currentScoreNotesArray.length; i++) {
            var note = currentScoreNotesArray[i][0]
            var pos = currentScoreNotesArray[i][1]

            if (pos > currentStep) {
                pos++
            }

            newScoreNotesArray.push([note, pos])
        }

        for (var i = 0; i < currentScoreHalfNotesArray.length; i++) {
            var note = currentScoreHalfNotesArray[i][0]
            var pos = currentScoreHalfNotesArray[i][1]
            var dur = currentScoreHalfNotesArray[i][2]

            if (pos > currentStep) {
                pos++
            }

            newScoreHalfNotesArray.push([note, pos, dur])
        }

        for (var i = 0; i < currentScoreDoubleNotesArray.length; i++) {
            var note = currentScoreDoubleNotesArray[i][0]
            var pos = currentScoreDoubleNotesArray[i][1]

            if (pos > currentStep) {
                pos++
            }

            newScoreDoubleNotesArray.push([note, pos])
        }

        newScore["notes"] = newScoreNotesArray
        newScore["halfnotes"] = newScoreHalfNotesArray
        newScore["doublenotes"] = newScoreDoubleNotesArray
        newScore["steps"] = newScore["steps"] + 1

        loadTrack(newScore)
        highlightStep(currentStep)
    }

    function deleteColAtCurrentPos() {
        var currentScore = getTheScore()
        var newScore = currentScore
        var currentScoreNotesArray = currentScore["notes"]
        var currentScoreHalfNotesArray = currentScore["halfnotes"]
        var currentScoreDoubleNotesArray = currentScore["doublenotes"]
        var newScoreNotesArray = []
        var newScoreHalfNotesArray = []
        var newScoreDoubleNotesArray = []

        if (currentStep == -1) {
            return
        }

        for (var i = 0; i < currentScoreNotesArray.length; i++) {
            var note = currentScoreNotesArray[i][0]
            var pos = currentScoreNotesArray[i][1]

            if (pos == currentStep) {
                continue
            }

            if (pos > currentStep) {
                pos--
            }

            newScoreNotesArray.push([note, pos])
        }

        for (var i = 0; i < currentScoreHalfNotesArray.length; i++) {
            var note = currentScoreHalfNotesArray[i][0]
            var pos = currentScoreHalfNotesArray[i][1]
            var dur = currentScoreHalfNotesArray[i][2]

            if (pos == currentStep) {
                continue
            }

            if (pos > currentStep) {
                pos--
            }

            newScoreHalfNotesArray.push([note, pos, dur])
        }

        for (var i = 0; i < currentScoreDoubleNotesArray.length; i++) {
            var note = currentScoreDoubleNotesArray[i][0]
            var pos = currentScoreDoubleNotesArray[i][1]

            if (pos == currentStep) {
                continue
            }

            if (pos > currentStep) {
                pos--
            }

            newScoreDoubleNotesArray.push([note, pos])
        }

        newScore["notes"] = newScoreNotesArray
        newScore["halfnotes"] = newScoreHalfNotesArray
        newScore["doublenotes"] = newScoreDoubleNotesArray
        newScore["steps"] = newScore["steps"] - 1

        if (currentStep >= newScore["steps"]) {
            currentStep--
        }

        loadTrack(newScore)
        highlightStep(currentStep)
    }

    function doBarShading(barLength) {
        var rule = `
            #theGrid td:nth-child(${barLength}n + 1){
                border-right: 1px solid royalblue !important;
            }
        `
        if (!document.getElementById("barshadestyle")) {
            var ruleElm = document.createElement("style")
            ruleElm.id = "barshadestyle"
            document.body.append(ruleElm)
        }
        else {
            var ruleElm = document.getElementById("barshadestyle")
        }

        ruleElm.innerText = rule
    }

    // stackoverflow saves the day again
    function b64DecodeUnicode(str) {
        // Going backwards: from bytestream, to percent-encoding, to original string.
        return decodeURIComponent(atob(str).split('').map(function (c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
    }

    function loadTrackFromJsonFile() {
        if (document.querySelector("#file").value == '') {
            document.getElementById("exportText").value = 'No file selected';
            return;
        }

        var file = document.querySelector("#file").files[0];

        var reader = new FileReader();
        reader.onload = function (e) {
            // document.getElementById("exportText").value = (e.target.result);
            document.getElementById("exportText").value = b64DecodeUnicode(e.target.result.split(",")[1]);
        };
        reader.onerror = function (e) {
            document.getElementById("exportText").value = 'Error reading file';
        };
        reader.readAsDataURL(file);
    }

    function wideMode() {
        var controlsDiv = document.getElementById("controls")

        if (!isWideModeEnabled) {
            controlsDiv.style.justifyContent = "space-evenly"
            controlsDiv.style.flexDirection = "row"
            controlsDiv.style.alignItems = "center"
            document.body.style.maxWidth = 'calc(100vw - 30px)'
            window.history.replaceState(null, null, "?wide=1");
            isWideModeEnabled = 1
        }
        else {
            controlsDiv.style.justifyContent = "unset"
            controlsDiv.style.flexDirection = "column"
            controlsDiv.style.alignItems = "center"
            document.body.style.maxWidth = '500px'
            window.history.replaceState(null, null, "?wide=0");
            isWideModeEnabled = 0
        }
    }

    function doubleSpace(doubleDouble) {
        var score = getTheScore()

        score["duration"] = score["duration"] / 2
        score["steps"] = score["steps"] * 2
        score["notes"] = score["notes"].map(x => [x[0], x[1] * 2])

        if (score["doublenotes"]) {
            score["doublenotes"] = score["doublenotes"].map(x => [x[0], x[1] * 2])
        }

        if (score["halfnotes"]) {
            score["halfnotes"] = score["halfnotes"].map(x => [x[0], x[1] * 2, x[2]])
        }

        if (doubleDouble) {
            score["notes"] = score["notes"].concat(score["notes"].map(x => [x[0], x[1] + 1]))
            if (score["doublenotes"]) {
                score["doublenotes"] = score["doublenotes"].concat(score["doublenotes"].map(x => [x[0], x[1] + 1]))
            }
            if (score["halfnotes"]) {
                score["halfnotes"] = score["halfnotes"].concat(score["halfnotes"].map(x => [x[0], x[1] + 1, x[2]]))
            }
        }

        loadTrack(score)
    }

    function setAttack(inputAttack) {
        attackTime = inputAttack * stepDuration
    }

    function setRelease(inputRelease) {
        releaseTime = inputRelease * stepDuration
    }

    function cycleNoteDuration(refreshCurrentOnly) {
        var switcherElm = document.getElementById("noteDurationSwitcher")
        var noteDurationArray = ["single", "double", "half"]
        var noteFunctionObj = {
            "single": addOnclickToGridCells,
            "double": addDoubleNoteOnclickToGridCells,
            "half": addHalfNoteOnclickToGridCells
        }
        var currentIdx = noteDurationArray.indexOf(notePickerDuration)
        var nextIdx = refreshCurrentOnly ? currentIdx : (currentIdx + 1) % noteDurationArray.length
        var nextDuration = noteDurationArray[nextIdx]

        notePickerDuration = nextDuration
        switcherElm.classList.remove(noteDurationArray[currentIdx])
        switcherElm.classList.add(nextDuration)

        removeAllNoteOnclickEvents()

        var noteFunction = noteFunctionObj[nextDuration]
        noteFunction()
    }

    function mod(n, m) {
        return ((n % m) + m) % m;
    }

    function transposeNote(inputNote, semitones) {
        var note = inputNote.slice(0, inputNote.length - 1) // won't work at A10, but you don't need that so go away
        var octave = parseInt(inputNote.slice(inputNote.length - 1))

        var returnNote = chromaticScale[mod((chromaticScale.indexOf(note) + semitones), chromaticScale.length)]
        var returnOctave = Math.floor(((octave * 12) + (chromaticScale.indexOf(note) + semitones)) / 12)

        return `${returnNote}${returnOctave}`
    }

    function transposeScore(semitones) {
        var returnScore = getTheScore()

        // return early if there aren't any notes
        if (!(returnScore["notes"].length + returnScore["halfnotes"].length + returnScore["doublenotes"].length)){
            console.warn("Nothing to transpose")
            return
        }

        // transpose the notes
        returnScore["notes"] = returnScore["notes"].map(x => [transposeNote(x[0], semitones), x[1]])
        returnScore["halfnotes"] = returnScore["halfnotes"].map(x => [transposeNote(x[0], semitones), x[1], x[2]])
        returnScore["doublenotes"] = returnScore["doublenotes"].map(x => [transposeNote(x[0], semitones), x[1]])

        // fix the octave start and number
        var allOctavesArray = [
            returnScore["notes"].map(x => parseInt(x[0].slice(x[0].length - 1))),
            returnScore["halfnotes"].map(x => parseInt(x[0].slice(x[0].length - 1))),
            returnScore["doublenotes"].map(x => parseInt(x[0].slice(x[0].length - 1)))
        ].flat()

        var minOctave = Math.min(...allOctavesArray)
        var maxOctave = Math.max(...allOctavesArray)

        returnScore["startOctave"] = minOctave
        returnScore["octaves"] = Math.max(maxOctave - minOctave, 2)

        if (maxOctave > 8 || minOctave < 1){
            console.error(`Cannot transpose any ${semitones > 0 ? "higher" : "lower"}`)
            return
        }

        loadTrack(returnScore)
    }

    function read_url_params_and_apply() {
        var url_string = window.location.href
        var url = new URL(url_string)
        try {
            var wide = parseInt(url.searchParams.get("wide"))
            if (wide) {
                wideMode()
            }
            var nowarn = parseInt(url.searchParams.get("nowarn"))
            if (nowarn) {
                doWarn = false
            }
        }
        catch {
            console.warn("Not impressed with your invalid URL parameters")
        }
    }


    function init() {
        stepChange(stepCount);
        trackSelectorGenerator();
        read_url_params_and_apply()

        if (doWarn) {
            window.onbeforeunload = function () { return "Your work will be lost."; };
        }
    }

    // globals
    var numberOfOctaves = 2
    var startOctave = 3
    var stepCount = 16
    var currentStep = -1
    var stepDuration = 0.5
    var chromaticScale = ["A", "A♯", "B", "C", "C♯", "D", "D♯", "E", "F", "F♯", "G", "G♯"]
    var audioCtx
    var mainGainNode
    var volume = 0.15
    var autoStepIntervalIdArray = []
    var waveform = "sine"
    var tempState
    var isWideModeEnabled = 0
    var theGrid = document.getElementById("theGrid")
    var doWarn = true
    var attackTime
    var releaseTime
    var notePickerDuration = "single"

    // init
    init();
</script>

<script>
    'use strict'

    // ridiculous conways game of life code that I wrote for https://ashe.org.uk/grid.html

    // so currentState is an array of arrays because position matters
    // nextState is just an array because position doesn't matter
    function conwayNextStep(currentState) {
        var nextState = []
        var gridWidth = currentState[0].length
        var gridHeight = currentState.length
        for (var y = 0; y < gridHeight; y++) {
            for (var x = 0; x < gridWidth; x++) {
                var neighbourCount = 0
                var nswe_coords = {}
                var cellState = currentState[y][x]
                var nextCellState = 0
                nswe_coords["north"] = [x, (((y - 1) % gridHeight) + gridHeight) % gridHeight]
                nswe_coords["south"] = [x, (y + 1) % gridHeight]
                nswe_coords["west"] = [(((x - 1) % gridWidth) + gridWidth) % gridWidth, y]
                nswe_coords["east"] = [(x + 1) % gridWidth, y]
                nswe_coords["nw"] = [nswe_coords["west"][0], nswe_coords["north"][1]]
                nswe_coords["ne"] = [nswe_coords["east"][0], nswe_coords["north"][1]]
                nswe_coords["sw"] = [nswe_coords["west"][0], nswe_coords["south"][1]]
                nswe_coords["se"] = [nswe_coords["east"][0], nswe_coords["south"][1]]
                for (var i in nswe_coords) {
                    var [xCoord, yCoord] = nswe_coords[i]
                    if (currentState[yCoord][xCoord]) {
                        neighbourCount += 1
                    }
                }
                if ((cellState && (neighbourCount == 2)) || (cellState && (neighbourCount == 3))) {
                    nextCellState = 1
                }
                else if ((!cellState) && (neighbourCount == 3)) {
                    nextCellState = 1
                }
                else {
                    nextCellState = 0
                }
                nextState.push(nextCellState)
            }
        }
        return nextState
    }

    function conwayCurrentState() {
        var currentState = []
        var gridBody = document.querySelector("#theGrid tbody")
        for (var i = 0; i < gridBody.rows.length; i++) {
            var rowState = []
            for (var j = 1; j < gridBody.rows[i].cells.length; j++) {
                rowState.push(gridBody.rows[i].cells[j].classList.contains("activeCell"))
            }
            currentState.push(rowState)
        }
        return currentState
    }

    function doConwayNextStep() {
        var nextStepString = conwayNextStep(conwayCurrentState()).join("")
        setPattern(nextStepString)
    }

    var refreshIntervalId = undefined

    function toggleConway(element) {
        if (!refreshIntervalId) {
            refreshIntervalId = setInterval(doConwayNextStep, conwayInterval)
            element.innerText = "Stop"
        }
        else {
            clearInterval(refreshIntervalId)
            refreshIntervalId = undefined
            element.innerText = "Start"
        }
    }

    function restartConway() {
        if (refreshIntervalId) {
            clearInterval(refreshIntervalId)
            refreshIntervalId = undefined
            refreshIntervalId = setInterval(doConwayNextStep, conwayInterval)
        }
    }

    function setPattern(patternString) {
        var gridCells = document.querySelectorAll("#theGrid tbody td:not(.step_-1)")

        for (var i = 0; i < gridCells.length; i++) {
            if (parseInt(patternString[i])) {
                gridCells[i].classList.add("activeCell")
            }
            else {
                gridCells[i].classList.remove("activeCell")
            }
        }
    }

    var conwayInterval = 500

</script>

</html>